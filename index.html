<!doctype html>
<html lang="en-KE">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Golden Star Restaurant - Order & Pay directly from table">
  <meta name="author" content="Golden Star Restaurant">
  <title>Golden Star Restaurant ‚Äî Order & Pay</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚≠ê</text></svg>">
  <style>
    :root {
      --primary: #111111;
      --secondary: #C9A24D;
      --accent: #1f6f3a;
      --light: #fffdf5;
      --dark: #101415;
      --card: #ffffff;
      --muted: rgba(16, 20, 21, 0.72);
      --muted2: rgba(16, 20, 21, 0.55);
      --stroke: rgba(16, 20, 21, 0.12);
      --shadow: 0 18px 55px rgba(0, 0, 0, 0.1);
      --radius: 18px;
      --max: 1100px;
      --transition: all 0.25s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: 
        radial-gradient(1200px 800px at 20% 0%, rgba(201, 162, 77, 0.16) 0%, transparent 60%),
        radial-gradient(900px 700px at 100% 20%, rgba(31, 111, 58, 0.1) 0%, transparent 55%),
        linear-gradient(135deg, var(--light) 0%, #f6f6f6 100%);
      color: var(--dark);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Focus styles for accessibility */
    :focus-visible {
      outline: 2px solid var(--secondary);
      outline-offset: 2px;
    }

    /* Header */
    header {
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(90deg, rgba(17, 17, 17, 0.96), rgba(0, 0, 0, 0.9));
      border-bottom: 1px solid rgba(255, 255, 255, 0.18);
      color: #fff;
    }

    .wrap {
      max-width: var(--max);
      margin: 0 auto;
      padding: 16px;
    }

    .top {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0; /* Allow text truncation */
    }

    .logoImg {
      width: 56px;
      height: 56px;
      border-radius: 16px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.28);
      padding: 6px;
      object-fit: cover;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(6px);
      flex-shrink: 0;
    }

    .title h1 {
      margin: 0;
      font-size: 18px;
      line-height: 1.1;
      color: var(--secondary);
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    .title p {
      margin: 3px 0 0;
      color: rgba(255, 255, 255, 0.82);
      font-size: 13px;
    }

    .title .location {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search {
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255, 255, 255, 0.22);
      background: rgba(255, 255, 255, 0.1);
      border-radius: 999px;
      padding: 8px 12px;
      min-width: 200px;
      flex-grow: 1;
      max-width: 300px;
    }

    .search input {
      border: 0;
      outline: 0;
      background: transparent;
      color: #fff;
      width: 100%;
      font-size: 14px;
    }

    .search input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Filter Pills */
    .pill {
      border: 1px solid rgba(255, 255, 255, 0.26);
      background: rgba(255, 255, 255, 0.12);
      color: #fff;
      padding: 9px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .pill:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.18);
    }

    .pill.active {
      border-color: rgba(201, 162, 77, 0.75);
      background: rgba(201, 162, 77, 0.22);
      color: #fff;
    }

    /* Table Status */
    .table-status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(31, 111, 58, 0.08);
      border: 1px solid rgba(31, 111, 58, 0.15);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
    }

    .table-status select {
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(255, 255, 255, 0.08);
      color: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 600;
      outline: none;
      cursor: pointer;
      min-width: 120px;
    }

    .table-status select:focus {
      border-color: var(--secondary);
    }

    .table-status option {
      color: var(--primary);
      background: white;
    }

    /* Main Content */
    main .wrap {
      padding-top: 24px;
      padding-bottom: 100px;
    }

    .section {
      margin: 24px 0 20px;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .section h2 {
      margin: 0;
      font-size: 18px;
      color: var(--primary);
      font-weight: 900;
    }

    .section small {
      color: rgba(16, 20, 21, 0.62);
      font-weight: 500;
      font-size: 13px;
    }

    /* Grid Layout */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: 1fr;
      }
      
      .top {
        gap: 12px;
      }
      
      .controls {
        width: 100%;
      }
      
      .search {
        min-width: 100%;
        max-width: 100%;
        order: 3;
      }
      
      .table-status {
        order: 1;
      }
      
      .controls > .pill {
        order: 2;
      }
    }

    /* Cards */
    .card {
      position: relative;
      overflow: hidden;
      padding: 0;
      min-height: 360px;
      background: #0b0f10;
      border: 1px solid rgba(16, 20, 21, 0.12);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      transition: var(--transition);
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.15);
    }

    .card .bg {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }

    .card:hover .bg {
      transform: scale(1.05);
    }

    .card .shade {
      position: absolute;
      inset: 0;
      background: linear-gradient(
        180deg,
        rgba(0, 0, 0, 0.45) 0%,
        rgba(0, 0, 0, 0.1) 35%,
        rgba(0, 0, 0, 0.8) 100%
      );
    }

    .card .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 16px;
      color: #fff;
      z-index: 2;
    }

    .card .topline {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .card .name {
      font-weight: 900;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: 0.2px;
      text-shadow: 0 10px 24px rgba(0, 0, 0, 0.45);
      flex-grow: 1;
    }

    .card .meta {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .card .tag {
      background: rgba(0, 0, 0, 0.45);
      border: 1px solid rgba(255, 255, 255, 0.18);
      color: #fff;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      backdrop-filter: blur(8px);
    }

    .card .bottom {
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.14);
      border-radius: 16px;
      padding: 14px;
      backdrop-filter: blur(10px);
    }

    .card .bullets {
      margin: 0;
      padding-left: 18px;
      font-size: 13px;
    }

    .card .bullets li {
      color: rgba(255, 255, 255, 0.92);
      margin-bottom: 4px;
    }

    .card .row {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .card .price {
      color: var(--secondary);
      font-weight: 900;
      font-size: 18px;
    }

    .card .small {
      color: rgba(255, 255, 255, 0.78);
      font-size: 12px;
    }

    /* Buttons */
    .btn {
      border: 0;
      background: linear-gradient(135deg, var(--secondary), #ffd98a);
      color: var(--primary);
      font-weight: 700;
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      font-size: 14px;
      transition: var(--transition);
      text-decoration: none;
      font-family: inherit;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(201, 162, 77, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn.secondary {
      background: #fff;
      color: var(--primary);
      border: 1px solid rgba(16, 20, 21, 0.14);
      font-weight: 600;
    }

    .btn.success {
      background: linear-gradient(135deg, #1f6f3a, #2a8c4a);
      color: white;
    }

    .btn.large {
      padding: 14px 20px;
      font-size: 16px;
    }

    .iconBtn {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(16, 20, 21, 0.14);
      background: #fff;
      color: var(--primary);
      cursor: pointer;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition);
    }

    .iconBtn:hover {
      background: #f5f5f5;
    }

    .iconBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Floating Cart */
    .floating {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      width: min(var(--max), calc(100% - 32px));
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 14px 18px;
      border-radius: 16px;
      border: 1px solid rgba(16, 20, 21, 0.12);
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.14);
      z-index: 40;
    }

    .floating .left {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }

    .floating .left b {
      font-size: 14px;
      color: var(--primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .floating .left span {
      font-size: 12px;
      color: rgba(16, 20, 21, 0.62);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .floating .right {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-shrink: 0;
    }

    .count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 28px;
      border-radius: 999px;
      background: rgba(31, 111, 58, 0.12);
      border: 1px solid rgba(31, 111, 58, 0.3);
      color: #0b3d22;
      font-weight: 900;
      padding: 0 10px;
      font-size: 12px;
    }

    /* Modals */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 100;
    }

    .modal.open {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .sheet {
      width: min(var(--max), 100%);
      max-height: 90vh;
      border-radius: var(--radius);
      border: 1px solid rgba(16, 20, 21, 0.12);
      background: #ffffff;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.18);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .sheetHead {
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(16, 20, 21, 0.1);
      background: linear-gradient(90deg, rgba(17, 17, 17, 0.96), rgba(0, 0, 0, 0.9));
      color: #fff;
      flex-shrink: 0;
    }

    .sheetHead b {
      font-size: 16px;
      font-weight: 600;
    }

    .sheetBody {
      padding: 16px;
      display: grid;
      gap: 12px;
      overflow-y: auto;
      flex-grow: 1;
    }

    .line {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      border: 1px solid rgba(16, 20, 21, 0.1);
      background: rgba(255, 255, 255, 0.92);
      border-radius: 14px;
      padding: 12px;
    }

    .line .info {
      display: grid;
      gap: 4px;
      min-width: 0;
      flex-grow: 1;
    }

    .line .info b {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .line .info small {
      color: var(--muted2);
      font-size: 12px;
    }

    .qty {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .qty span {
      min-width: 24px;
      text-align: center;
      font-weight: 600;
    }

    .totalRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-top: 1px solid rgba(16, 20, 21, 0.1);
      background: rgba(255, 250, 240, 0.8);
      flex-shrink: 0;
    }

    .totalRow b {
      font-size: 16px;
    }

    /* Payment Options */
    .payment-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin: 16px 0;
    }

    .payment-option {
      border: 2px solid rgba(16, 20, 21, 0.1);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background: white;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .payment-option:hover {
      border-color: var(--secondary);
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .payment-option.selected {
      border-color: var(--accent);
      background: rgba(31, 111, 58, 0.05);
    }

    .payment-option .icon {
      font-size: 28px;
      margin-bottom: 8px;
    }

    .payment-option .name {
      font-weight: 700;
      font-size: 14px;
      margin-bottom: 4px;
    }

    .payment-option .desc {
      font-size: 11px;
      color: var(--muted2);
      line-height: 1.3;
    }

    /* Payment Details */
    .payment-details {
      margin-top: 16px;
      padding: 16px;
      background: rgba(255, 250, 240, 0.8);
      border-radius: 12px;
      border: 1px solid rgba(16, 20, 21, 0.1);
      animation: slideUp 0.3s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .payment-details.hidden {
      display: none;
    }

    .mpesa-details {
      background: rgba(31, 111, 58, 0.05);
      border: 1px solid rgba(31, 111, 58, 0.15);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .mpesa-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .copy-btn {
      background: rgba(31, 111, 58, 0.1);
      border: 1px solid rgba(31, 111, 58, 0.2);
      border-radius: 6px;
      padding: 6px 10px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition);
    }

    .copy-btn:hover {
      background: rgba(31, 111, 58, 0.2);
    }

    /* Success Screen */
    .success-screen {
      text-align: center;
      padding: 30px 20px;
    }

    .success-icon {
      font-size: 48px;
      margin-bottom: 20px;
      color: var(--accent);
      animation: scaleIn 0.5s ease;
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .success-screen h3 {
      margin: 0 0 12px 0;
      color: var(--accent);
      font-size: 20px;
    }

    .success-screen p {
      color: var(--muted2);
      margin-bottom: 24px;
      line-height: 1.5;
    }

    .order-id {
      background: rgba(201, 162, 77, 0.1);
      border: 1px solid rgba(201, 162, 77, 0.2);
      border-radius: 8px;
      padding: 12px;
      font-family: monospace;
      font-weight: 700;
      letter-spacing: 1px;
      margin: 16px 0;
      text-align: center;
      font-size: 14px;
    }

    /* PayStack Styles */
    .paystack-processing {
      text-align: center;
      padding: 20px;
    }

    .paystack-processing .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .phone-input {
      width: 100%;
      padding: 12px;
      border: 1px solid rgba(16, 20, 21, 0.2);
      border-radius: 10px;
      font-size: 15px;
      margin-bottom: 12px;
      transition: var(--transition);
    }

    .phone-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(31, 111, 58, 0.1);
    }

    .whatsapp-forwarding {
      text-align: center;
      padding: 16px;
      background: rgba(31, 111, 58, 0.08);
      border: 1px solid rgba(31, 111, 58, 0.15);
      border-radius: 10px;
      margin: 12px 0;
    }

    .whatsapp-forwarding p {
      margin: 0;
      font-size: 13px;
      color: var(--accent);
      line-height: 1.4;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: var(--primary);
    }

    .empty-state p {
      margin: 0;
      font-size: 14px;
    }

    /* Toast notifications */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--accent);
      color: white;
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      animation: slideInRight 0.3s ease;
      max-width: 300px;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Loading state */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }

    /* Media queries for better mobile experience */
    @media (max-width: 480px) {
      .modal {
        padding: 8px;
      }
      
      .sheetHead {
        padding: 14px;
      }
      
      .sheetBody {
        padding: 14px;
      }
      
      .payment-options {
        grid-template-columns: 1fr;
      }
      
      .floating {
        width: calc(100% - 16px);
        bottom: 8px;
        padding: 12px 16px;
      }
      
      .floating .right {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }
      
      .floating .right .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <img class="logoImg"
           src="https://i.ibb.co/S7PTSxV2/366441906-199503619771146-2457626318855539694-n.jpg"
           alt="Golden Star Restaurant Logo"
           width="56"
           height="56"
           loading="eager">
      <div class="title">
        <h1>Golden Star Restaurant</h1>
        <p>Order & Pay directly from table</p>
        <div class="location">
          üìç Banda Street, Nairobi ‚Ä¢ üåê goldenstar.co.ke
        </div>
      </div>
    </div>

    <div class="controls">
      <div class="table-status" id="tableStatus">
        <span>üè† Table:</span>
        <select id="tableNumber" aria-label="Select your table number">
          <option value="">Select Table</option>
          <option value="1">Table 1</option>
          <option value="2">Table 2</option>
          <option value="3">Table 3</option>
          <option value="4">Table 4</option>
          <option value="5">Table 5</option>
          <option value="6">Table 6</option>
          <option value="7">Table 7</option>
          <option value="8">Table 8</option>
          <option value="9">Table 9</option>
          <option value="10">Table 10</option>
          <option value="VIP 1">VIP 1</option>
          <option value="VIP 2">VIP 2</option>
          <option value="Take Away">Take Away</option>
          <option value="Delivery">Delivery</option>
        </select>
      </div>

      <div class="search">
        <span aria-hidden="true" style="opacity:0.7">üîé</span>
        <input id="q" 
               placeholder="Search menu..." 
               type="search" 
               aria-label="Search menu items"
               autocomplete="off">
      </div>

      <div class="filter-pills">
        <button class="pill active" data-cat="All" aria-label="Show all menu items">All</button>
        <button class="pill" data-cat="Breakfast" aria-label="Show breakfast items">Breakfast</button>
        <button class="pill" data-cat="Lunch" aria-label="Show lunch items">Lunch</button>
        <button class="pill" data-cat="Specials" aria-label="Show specials">Specials</button>
        <button class="pill" data-cat="Drinks" aria-label="Show drinks">Drinks</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div class="section">
      <h2>Menu</h2>
      <small>Select items, choose payment method, and order directly to kitchen</small>
    </div>

    <div id="grid" class="grid">
      <!-- Menu items will be loaded by JavaScript -->
      <div class="empty-state" id="loadingState">
        <div class="icon">üçΩÔ∏è</div>
        <h3>Loading Menu...</h3>
        <p>Please wait while we load the delicious options</p>
      </div>
    </div>
  </div>
</main>

<!-- Floating Cart -->
<div class="floating" role="region" aria-label="Order summary">
  <div class="left">
    <b>Your Order ‚Ä¢ <span id="currentTable">No Table Selected</span></b>
    <span id="summary">No items yet</span>
  </div>
  <div class="right">
    <span class="count" id="count" aria-live="polite">0</span>
    <button class="btn secondary" id="openCart" aria-label="View your order">Review Order</button>
    <button class="btn success" id="checkoutBtn" aria-label="Proceed to checkout" disabled>Proceed to Payment</button>
  </div>
</div>

<!-- Cart Modal -->
<div class="modal" id="cartModal" role="dialog" aria-labelledby="cartTitle" aria-hidden="true">
  <div class="sheet">
    <div class="sheetHead">
      <b id="cartTitle">Order Summary ‚Ä¢ <span id="modalTable">Table: --</span></b>
      <button class="btn secondary" id="closeCart" aria-label="Close order summary">Close</button>
    </div>
    <div class="sheetBody" id="cartLines">
      <div class="empty-state" id="emptyCartMessage">
        <div class="icon">üõí</div>
        <h3>Your cart is empty</h3>
        <p>Add items from the menu to get started</p>
      </div>
    </div>
    <div class="totalRow">
      <div>
        <b id="total">Total: KES 0</b><br>
        <span class="small" id="orderNote"></span>
      </div>
      <button class="btn success" id="proceedToPayment" disabled>Continue to Payment</button>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div class="modal" id="paymentModal" role="dialog" aria-labelledby="paymentTitle" aria-hidden="true">
  <div class="sheet">
    <div class="sheetHead">
      <b id="paymentTitle">Complete Payment</b>
      <button class="btn secondary" id="closePayment" aria-label="Close payment">Back</button>
    </div>
    <div class="sheetBody">
      <h4 style="margin:0 0 12px 0;">Select Payment Method</h4>

      <div class="payment-options" id="paymentOptions">
        <div class="payment-option" data-method="paystack">
          <div class="icon">üì±</div>
          <div class="name">Pay with M-Pesa</div>
          <div class="desc">Auto-pay on phone</div>
        </div>

        <div class="payment-option" data-method="mpesa">
          <div class="icon">üí≥</div>
          <div class="name">MPesa Manual</div>
          <div class="desc">Pay via MPesa Till</div>
        </div>

        <div class="payment-option" data-method="bank">
          <div class="icon">üè¶</div>
          <div class="name">Bank Transfer</div>
          <div class="desc">Send to bank account</div>
        </div>

        <div class="payment-option" data-method="cash">
          <div class="icon">üí∞</div>
          <div class="name">Cash</div>
          <div class="desc">Pay at counter</div>
        </div>
      </div>

      <!-- Paystack STK Push Payment Details -->
      <div class="payment-details hidden" id="paystackDetails">
        <h4>Pay with M-Pesa (STK Push)</h4>
        
        <div style="margin:20px 0;">
          <label for="paystackPhone" style="display:block; margin-bottom:8px; font-weight:600;">
            M-Pesa Registered Phone
          </label>
          <input type="tel" 
                 id="paystackPhone" 
                 placeholder="2547XXXXXXXX"
                 class="phone-input"
                 value="2547"
                 aria-describedby="phoneHelp">
          <p id="phoneHelp" style="font-size:12px; color:#666; margin-top:5px;">
            You'll receive an M-Pesa prompt on this phone
          </p>
        </div>
        
        <div style="background:#f0f9ff; border:1px solid #b6e0fe; border-radius:10px; padding:12px; margin:16px 0;">
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
            <span>Table:</span>
            <strong id="paystackTable">--</strong>
          </div>
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
            <span>Amount:</span>
            <strong id="paystackAmount">KES 0</strong>
          </div>
          <div style="display:flex; justify-content:space-between;">
            <span>Reference:</span>
            <strong id="paystackReference">GS-ORDER-</strong>
          </div>
        </div>
        
        <div class="paystack-processing" id="paystackProcessing" style="display:none;">
          <div class="spinner"></div>
          <p>Sending payment request to your phone...</p>
          <p style="font-size:12px;">Check your phone for M-Pesa PIN prompt</p>
        </div>
        
        <button class="btn success large" id="initiatePaystack">
          üì± Send Payment Request to Phone
        </button>
        
        <div class="whatsapp-forwarding">
          <p>
            ‚úÖ Order will automatically be sent to restaurant WhatsApp
          </p>
        </div>
      </div>

      <!-- MPesa Payment Details -->
      <div class="payment-details hidden" id="mpesaDetails">
        <h4>MPesa Till Payment</h4>
        <div class="mpesa-details">
          <div class="mpesa-row">
            <span>Business No (Till):</span>
            <strong id="mpesaTill">888555</strong>
            <button class="copy-btn" data-copy="888555" aria-label="Copy till number">Copy</button>
          </div>
          <div class="mpesa-row" style="margin-top:8px;">
            <span>Account/Ref:</span>
            <strong id="mpesaRef">TABLE-</strong>
            <button class="copy-btn" id="copyMpesaRef" aria-label="Copy reference">Copy</button>
          </div>
          <div class="mpesa-row" style="margin-top:8px;">
            <span>Amount:</span>
            <strong id="mpesaAmount">KES 0</strong>
            <button class="copy-btn" id="copyMpesaAmount" aria-label="Copy amount">Copy</button>
          </div>
        </div>
        <p style="font-size:12px; color:var(--muted2); margin:12px 0;">
          üì± MPesa ‚Üí Lipa Na MPesa ‚Üí Buy Goods ‚Üí Enter Till <strong id="mpesaTill2">888555</strong><br>
          üí° Use reference: <strong id="mpesaTable">--</strong>
        </p>
        
        <div class="whatsapp-forwarding">
          <p>
            ‚úÖ After payment, order will auto-send to restaurant WhatsApp
          </p>
        </div>
        
        <button class="btn success" id="confirmMpesa">I have paid via MPesa</button>
      </div>

      <!-- Bank Payment Details -->
      <div class="payment-details hidden" id="bankDetails">
        <h4>Bank Transfer Details</h4>
        <div style="background:rgba(16,20,21,.03); border:1px solid rgba(16,20,21,.10); border-radius:10px; padding:12px;">
          <div class="mpesa-row">
            <span>Bank:</span>
            <strong id="bankName">KCB Bank</strong>
            <button class="copy-btn" data-copy="KCB Bank" aria-label="Copy bank name">Copy</button>
          </div>
          <div class="mpesa-row" style="margin-top:8px;">
            <span>Account No:</span>
            <strong id="bankAcc">0123456789</strong>
            <button class="copy-btn" data-copy="0123456789" aria-label="Copy account number">Copy</button>
          </div>
          <div class="mpesa-row" style="margin-top:8px;">
            <span>Account Name:</span>
            <strong id="bankAccName">GOLDEN STAR RESTAURANT</strong>
            <button class="copy-btn" data-copy="GOLDEN STAR RESTAURANT" aria-label="Copy account name">Copy</button>
          </div>
          <div class="mpesa-row" style="margin-top:8px;">
            <span>Reference:</span>
            <strong id="bankRef">TABLE-</strong>
            <button class="copy-btn" id="copyBankRef" aria-label="Copy reference">Copy</button>
          </div>
          <div class="mpesa-row" style="margin-top:8px;">
            <span>Amount:</span>
            <strong id="bankAmount">KES 0</strong>
            <button class="copy-btn" id="copyBankAmount" aria-label="Copy amount">Copy</button>
          </div>
        </div>

        <p style="font-size:12px; color:var(--muted2); margin:12px 0;">
          üè¶ Please use reference: <strong id="bankTable">--</strong>
        </p>
        
        <div class="whatsapp-forwarding">
          <p>
            ‚úÖ After payment, order will auto-send to restaurant WhatsApp
          </p>
        </div>

        <button class="btn success" id="confirmBank">I have sent bank transfer</button>
      </div>

      <!-- Cash Payment Details -->
      <div class="payment-details hidden" id="cashDetails">
        <h4>Cash Payment</h4>
        <p style="font-size:13px; color:var(--muted2); margin-bottom:16px;">
          Pay at the counter. Your order will be prepared immediately.
        </p>
        <div style="background:#f8f8f8; padding:12px; border-radius:8px; margin-bottom:16px;">
          <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
            <span>Order Total:</span>
            <strong id="cashAmount">KES 0</strong>
          </div>
          <div style="display:flex; justify-content:space-between; font-size:13px;">
            <span>Table:</span>
            <strong id="cashTable">--</strong>
          </div>
        </div>
        
        <div class="whatsapp-forwarding">
          <p>
            ‚úÖ Order will automatically be sent to restaurant WhatsApp
          </p>
        </div>
        
        <button class="btn success" id="confirmCash">Confirm Cash Order</button>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
<div class="modal" id="successModal" role="dialog" aria-labelledby="successTitle" aria-hidden="true">
  <div class="sheet">
    <div class="sheetHead">
      <b id="successTitle">Order Confirmed! üéâ</b>
    </div>
    <div class="success-screen">
      <div class="success-icon">‚úÖ</div>
      <h3>Order Received Successfully!</h3>
      <p>Your order has been sent to the kitchen. You will receive your food shortly.</p>

      <div class="order-id" id="orderId">ORDER-#GS-001</div>

      <div style="background:#f8f8f8; padding:16px; border-radius:10px; text-align:left; margin:16px 0;">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span>Table:</span>
          <strong id="successTable">--</strong>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span>Items:</span>
          <strong id="successItems">0</strong>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <span>Total:</span>
          <strong id="successTotal">KES 0</strong>
        </div>
        <div style="display:flex; justify-content:space-between;">
          <span>Payment:</span>
          <strong id="successPayment">--</strong>
        </div>
      </div>
      
      <div class="whatsapp-forwarding" style="margin:16px 0;">
        <p>
          ‚úÖ Order forwarded to restaurant WhatsApp: +254740940395
        </p>
      </div>

      <p style="font-size:13px; color:var(--muted2); margin-bottom:24px;">
        üìã Order details sent to kitchen<br>
        ‚è±Ô∏è Estimated time: 15-20 minutes
      </p>

      <div style="display:flex; gap:12px; justify-content:center;">
        <button class="btn" id="sendWhatsApp">üì± Send Copy to My WhatsApp</button>
        <button class="btn secondary" id="newOrder">Start New Order</button>
      </div>
    </div>
  </div>
</div>

<script src="menu.js" defer></script>

<script>
// ========= PROFESSIONAL PAYMENT + AUTO-WHATSAPP SYSTEM =========
// This system:
// 1. Adds PayStack back for easy M-Pesa payments
// 2. Automatically sends full order details to your WhatsApp (+254740940395)
// 3. No manual confirmation needed - order auto-forwards after payment

// PAYSTACK CONFIGURATION - USE YOUR LIVE KEYS
const PAYSTACK_CONFIG = {
  // TEST KEYS (for testing)
  // publicKey: "pk_test_929f9c92fa658760bb56bd96a63fa91619c94c3",
  
  // LIVE KEYS (for production - USE THESE)
  publicKey: "pk_live_1aede7667d50adb2147614cb580a9513552c0aa9",
  
  restaurantName: "Golden Star Restaurant",
  restaurantEmail: "orders@goldenstar.co.ke"
};

// RESTAURANT WHATSAPP NUMBER FOR AUTO-FORWARDING
const RESTAURANT_WHATSAPP = "+254740940395";

const CONFIG = {
  restaurantName: "Golden Star Restaurant",
  whatsappTo: RESTAURANT_WHATSAPP,
  mpesaTill: "888555",
  bankName: "KCB Bank",
  bankAccount: "0123456789",
  bankAccountName: "GOLDEN STAR RESTAURANT",
};

// Helper functions
const el = (id) => document.getElementById(id);
const fmtKES = (n) => `KES ${Number(n || 0).toLocaleString("en-KE")}`;
const showToast = (message, type = 'success') => {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  toast.style.background = type === 'error' ? '#dc3545' : 
                          type === 'warning' ? '#ffc107' : 
                          'var(--accent)';
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
};

// State
let selectedPayment = "";
let lastOrderPayload = null;
let paystackInitialized = false;
let cartItems = [];
let cartTotal = 0;
let cartCount = 0;

// Initialize
function initApp() {
  // Initialize Paystack
  initPaystack();
  
  // Setup event listeners
  setupEventListeners();
  
  // Update UI
  updateCartUI();
  tick();
}

// Paystack initialization
function initPaystack() {
  if (paystackInitialized) return;
  
  // Check if Paystack is already loaded
  if (window.PaystackPop) {
    paystackInitialized = true;
    return;
  }
  
  const script = document.createElement('script');
  script.src = "https://js.paystack.co/v1/inline.js";
  script.onload = () => {
    console.log("Paystack loaded successfully");
    paystackInitialized = true;
    
    // Show Paystack option as available
    const paystackOption = document.querySelector('.payment-option[data-method="paystack"]');
    if (paystackOption) {
      paystackOption.style.opacity = '1';
    }
  };
  script.onerror = () => {
    console.error("Failed to load Paystack");
    const paystackOption = document.querySelector('.payment-option[data-method="paystack"]');
    if (paystackOption) {
      paystackOption.style.opacity = '0.5';
      paystackOption.title = "Paystack temporarily unavailable";
    }
  };
  document.head.appendChild(script);
}

// Event listeners setup
function setupEventListeners() {
  // Table selection
  el("tableNumber").addEventListener("change", handleTableChange);
  
  // Cart modal
  el("openCart").addEventListener("click", () => el("cartModal").classList.add("open"));
  el("closeCart").addEventListener("click", () => el("cartModal").classList.remove("open"));
  el("closePayment").addEventListener("click", () => el("paymentModal").classList.remove("open"));
  
  // Checkout
  el("checkoutBtn").addEventListener("click", handleCheckout);
  el("proceedToPayment").addEventListener("click", handleProceedToPayment);
  
  // Payment methods
  document.querySelectorAll(".payment-option").forEach(opt => {
    opt.addEventListener("click", handlePaymentSelection);
  });
  
  // Copy buttons
  document.addEventListener("click", handleCopyButtonClick);
  
  // Payment confirmations
  el("confirmMpesa").addEventListener("click", () => finalizeOrder("MPesa Till"));
  el("confirmBank").addEventListener("click", () => finalizeOrder("Bank Transfer"));
  el("confirmCash").addEventListener("click", () => finalizeOrder("Cash"));
  el("initiatePaystack").addEventListener("click", handlePaystackPayment);
  
  // Success modal
  el("newOrder").addEventListener("click", handleNewOrder);
  el("sendWhatsApp").addEventListener("click", handleSendWhatsApp);
}

// Event handlers
function handleTableChange() {
  const table = getTableLabel();
  el("currentTable").textContent = table || "No Table Selected";
  el("modalTable").textContent = `Table: ${table || "--"}`;
  
  // Update references
  updatePaymentReferences(table);
  
  // Update checkout button state
  updateCheckoutButtonState();
}

function handleCheckout() {
  if (!requireTable()) return;
  
  const items = getCartItems();
  if (items.length === 0) {
    showToast("Please add items to your order first", "warning");
    return;
  }
  
  el("cartModal").classList.remove("open");
  el("paymentModal").classList.add("open");
  refreshAmountsInPaymentPanels();
  
  // Initialize Paystack if not already
  initPaystack();
  
  // Select Paystack by default
  setTimeout(() => {
    document.querySelectorAll(".payment-option").forEach(x => x.classList.remove("selected"));
    const paystackOption = document.querySelector('.payment-option[data-method="paystack"]');
    if (paystackOption) {
      paystackOption.classList.add("selected");
      selectedPayment = "paystack";
      
      // Show Paystack panel
      ["mpesa","bank","cash","paystack"].forEach(m => {
        el(m + "Details").classList.add("hidden");
      });
      el("paystackDetails").classList.remove("hidden");
    }
  }, 100);
}

function handleProceedToPayment() {
  if (!requireTable()) return;
  el("cartModal").classList.remove("open");
  el("paymentModal").classList.add("open");
  refreshAmountsInPaymentPanels();
  initPaystack();
}

function handlePaymentSelection(e) {
  const opt = e.currentTarget;
  document.querySelectorAll(".payment-option").forEach(x => x.classList.remove("selected"));
  opt.classList.add("selected");
  selectedPayment = opt.dataset.method;

  // Show relevant panel
  ["mpesa","bank","cash","paystack"].forEach(m => {
    el(m + "Details").classList.add("hidden");
  });
  el(selectedPayment + "Details").classList.remove("hidden");
}

async function handleCopyButtonClick(e) {
  const btn = e.target.closest(".copy-btn");
  if (!btn) return;

  let v = btn.getAttribute("data-copy");
  if (!v && btn.id === "copyMpesaRef") v = el("mpesaRef").textContent;
  if (!v && btn.id === "copyBankRef") v = el("bankRef").textContent;
  if (!v && btn.id === "copyMpesaAmount") v = String(cartTotal);
  if (!v && btn.id === "copyBankAmount") v = String(cartTotal);

  try {
    await navigator.clipboard.writeText(v || "");
    showToast("Copied to clipboard!");
    btn.textContent = "Copied";
    setTimeout(() => btn.textContent = "Copy", 1000);
  } catch {
    showToast("Failed to copy. Please copy manually.", "error");
  }
}

function handlePaystackPayment() {
  const phone = el("paystackPhone").value.trim();
  const amount = cartTotal;
  const table = getTableLabel();
  
  if (!phone.match(/^2547\d{8}$/)) {
    showToast("Please enter valid Kenyan phone number (2547XXXXXXXX)", "warning");
    el("paystackPhone").focus();
    return;
  }
  
  if (!table) {
    showToast("Please select your table first", "warning");
    return;
  }
  
  if (amount <= 0) {
    showToast("Your cart is empty", "warning");
    return;
  }
  
  if (!paystackInitialized) {
    showToast("Payment system is loading. Please try again.", "warning");
    initPaystack();
    return;
  }
  
  // Show processing
  el("paystackProcessing").style.display = "block";
  const button = el("initiatePaystack");
  button.disabled = true;
  button.innerHTML = '<span class="loading"></span> Processing...';
  
  // Generate unique reference
  const reference = `GS-${table.replace(/\s+/g, "")}-${Date.now().toString().slice(-6)}`;
  
  // Initialize Paystack payment
  const handler = PaystackPop.setup({
    key: PAYSTACK_CONFIG.publicKey,
    email: PAYSTACK_CONFIG.restaurantEmail,
    amount: amount * 100,
    currency: "KES",
    ref: reference,
    metadata: {
      custom_fields: [
        {
          display_name: "Table",
          variable_name: "table",
          value: table
        },
        {
          display_name: "Phone",
          variable_name: "phone",
          value: phone
        }
      ]
    },
    channels: ['mobile_money'],
    callback: function(response) {
      // Payment successful
      el("paystackProcessing").style.display = "none";
      button.disabled = false;
      button.textContent = "üì± Send Payment Request to Phone";
      
      // Store payment reference
      window.paymentReference = response.reference;
      window.paymentConfirmed = true;
      
      // Finalize the order
      finalizeOrderWithAutoWhatsApp("M-Pesa STK Push (Paystack)", response.reference);
    },
    onClose: function() {
      // Payment cancelled
      el("paystackProcessing").style.display = "none";
      button.disabled = false;
      button.textContent = "üì± Send Payment Request to Phone";
      
      if (!window.paymentConfirmed) {
        showToast("Payment was cancelled. You can try again.", "warning");
      }
    }
  });
  
  // Open Paystack modal
  handler.openIframe();
  
  // Set timeout to reset button
  setTimeout(() => {
    if (el("paystackProcessing").style.display === "block") {
      el("paystackProcessing").style.display = "none";
      button.disabled = false;
      button.textContent = "üì± Send Payment Request to Phone";
      showToast("Payment request timed out. Please try again.", "warning");
    }
  }, 30000);
}

function handleNewOrder() {
  el("successModal").classList.remove("open");
  lastOrderPayload = null;
  
  // Clear cart
  cartItems = [];
  cartTotal = 0;
  cartCount = 0;
  
  // Update UI
  updateCartUI();
  
  // Reset form
  el("summary").textContent = "No items yet";
  el("count").textContent = "0";
  el("paystackPhone").value = "2547";
  
  // Reset payment confirmation
  window.paymentConfirmed = false;
  
  showToast("Ready for new order!");
}

function handleSendWhatsApp() {
  if (!lastOrderPayload || !lastOrderPayload.customerMessage) {
    showToast("No order details available", "error");
    return;
  }
  
  const encodedMsg = encodeURIComponent(lastOrderPayload.customerMessage);
  const whatsappUrl = `https://wa.me/?text=${encodedMsg}`;
  window.open(whatsappUrl, '_blank');
}

// Utility functions
function getTableLabel() {
  const v = el("tableNumber").value;
  if (!v) return "";
  if (v === "Take Away" || v === "Delivery") return v;
  return v.toString().startsWith("Table") || v.toString().startsWith("VIP") 
    ? v 
    : `Table ${v}`;
}

function requireTable() {
  const t = getTableLabel();
  if (!t) {
    showToast("Please select your table before checkout", "warning");
    el("tableNumber").focus();
    return false;
  }
  return true;
}

function updatePaymentReferences(table) {
  const ref = table ? table.replace(/\s+/g, "-").toUpperCase() : "TABLE-";
  el("mpesaRef").textContent = ref;
  el("mpesaTable").textContent = ref;
  el("bankRef").textContent = ref;
  el("bankTable").textContent = ref;
  el("cashTable").textContent = table || "--";
  el("paystackTable").textContent = table || "--";
  el("paystackReference").textContent = `GS-${table ? table.replace(/\s+/g, "") : "ORDER"}-${Date.now().toString().slice(-6)}`;
}

function refreshAmountsInPaymentPanels() {
  const total = cartTotal;
  const t = getTableLabel();

  el("mpesaTill").textContent = CONFIG.mpesaTill;
  el("mpesaTill2").textContent = CONFIG.mpesaTill;
  el("mpesaAmount").textContent = fmtKES(total);

  el("bankName").textContent = CONFIG.bankName;
  el("bankAcc").textContent = CONFIG.bankAccount;
  el("bankAccName").textContent = CONFIG.bankAccountName;
  el("bankAmount").textContent = fmtKES(total);

  el("cashAmount").textContent = fmtKES(total);
  el("cashTable").textContent = t || "--";

  // Paystack amounts
  el("paystackAmount").textContent = fmtKES(total);
  el("paystackTable").textContent = t || "--";
}

function getCartItems() {
  return cartItems;
}

function updateCartTotal() {
  cartTotal = cartItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  cartCount = cartItems.reduce((sum, item) => sum + item.quantity, 0);
}

function updateCartUI() {
  // Update floating cart
  const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
  const itemCount = totalItems;
  const itemText = totalItems === 1 ? "1 item" : `${totalItems} items`;
  
  el("count").textContent = itemCount;
  el("summary").textContent = itemCount > 0 ? `${itemText} ‚Ä¢ ${fmtKES(cartTotal)}` : "No items yet";
  
  // Update cart modal
  const cartLines = el("cartLines");
  const emptyCartMessage = el("emptyCartMessage");
  
  if (cartItems.length === 0) {
    emptyCartMessage.style.display = "block";
    cartLines.innerHTML = '';
    el("total").textContent = "Total: KES 0";
    el("proceedToPayment").disabled = true;
  } else {
    emptyCartMessage.style.display = "none";
    
    const linesHTML = cartItems.map(item => `
      <div class="line" data-id="${item.id}">
        <div class="info">
          <b>${item.name}</b>
          <small>${fmtKES(item.price)} each</small>
        </div>
        <div class="qty">
          <button class="iconBtn qty-minus" aria-label="Decrease quantity">‚àí</button>
          <span>${item.quantity}</span>
          <button class="iconBtn qty-plus" aria-label="Increase quantity">+</button>
        </div>
        <div style="font-weight:600; min-width:80px; text-align:right;">
          ${fmtKES(item.price * item.quantity)}
        </div>
      </div>
    `).join('');
    
    cartLines.innerHTML = linesHTML;
    el("total").textContent = `Total: ${fmtKES(cartTotal)}`;
    el("proceedToPayment").disabled = false;
    
    // Add event listeners for quantity buttons
    cartLines.querySelectorAll('.qty-minus').forEach(btn => {
      btn.addEventListener('click', function() {
        const line = this.closest('.line');
        const itemId = line.dataset.id;
        updateItemQuantity(itemId, -1);
      });
    });
    
    cartLines.querySelectorAll('.qty-plus').forEach(btn => {
      btn.addEventListener('click', function() {
        const line = this.closest('.line');
        const itemId = line.dataset.id;
        updateItemQuantity(itemId, 1);
      });
    });
  }
}

function updateItemQuantity(itemId, change) {
  const item = cartItems.find(item => item.id === itemId);
  if (!item) return;
  
  const newQuantity = item.quantity + change;
  if (newQuantity < 1) {
    // Remove item from cart
    cartItems = cartItems.filter(item => item.id !== itemId);
  } else {
    item.quantity = newQuantity;
  }
  
  updateCartTotal();
  updateCartUI();
  updateCheckoutButtonState();
}

function updateCheckoutButtonState() {
  const hasItems = cartItems.length > 0;
  const hasTable = !!getTableLabel();
  el("checkoutBtn").disabled = !(hasItems && hasTable);
}

function generateOrderId() {
  const d = new Date();
  const y = d.getFullYear().toString().slice(-2);
  const m = String(d.getMonth() + 1).padStart(2, "0");
  const day = String(d.getDate()).padStart(2, "0");
  const rand = Math.floor(100 + Math.random() * 900);
  return `GS-${y}${m}${day}-${rand}`;
}

function buildRestaurantWhatsAppMessage(payload) {
  const lines = payload.items.map(it => `‚Ä¢ ${it.name} x${it.quantity} ‚Äî ${fmtKES(it.price * it.quantity)}`);
  const totalItems = payload.items.reduce((sum, it) => sum + it.quantity, 0);
  
  return [
    `üö® *NEW ORDER - GOLDEN STAR RESTAURANT* üö®`,
    `üìÖ ${new Date().toLocaleDateString('en-KE', { 
      weekday: 'long', 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric', 
      hour: '2-digit', 
      minute: '2-digit' 
    })}`,
    `üìã *Order ID:* ${payload.orderId}`,
    `üè† *Table/Service:* ${payload.table}`,
    `üí∞ *Payment Method:* ${payload.paymentLabel}`,
    payload.paymentReference ? `üî¢ *Payment Ref:* ${payload.paymentReference}` : '',
    `üìä *Total Items:* ${totalItems}`,
    `üíµ *Order Total:* ${fmtKES(payload.total)}`,
    ``,
    `üìù *ORDER ITEMS:*`,
    ...lines,
    ``,
    `‚è±Ô∏è *Status:* PENDING`,
    `üë®‚Äçüç≥ *Action Required:* Prepare order immediately`,
    ``,
    `‚úÖ *Auto-generated by Restaurant Order System*`
  ].filter(Boolean).join("\n");
}

function buildCustomerWhatsAppMessage(payload) {
  const lines = payload.items.map(it => `‚Ä¢ ${it.name} x${it.quantity} ‚Äî ${fmtKES(it.price * it.quantity)}`);
  return [
    `‚úÖ *${CONFIG.restaurantName} ‚Äî Order Confirmed*`,
    `üéâ Thank you for your order!`,
    ``,
    `üìã *Order ID:* ${payload.orderId}`,
    `üè† *Table:* ${payload.table}`,
    `üí∞ *Payment:* ${payload.paymentLabel}`,
    payload.paymentReference ? `üî¢ *Payment Ref:* ${payload.paymentReference}` : '',
    `üíµ *Total:* ${fmtKES(payload.total)}`,
    ``,
    `üìù *Your Order:*`,
    ...lines,
    ``,
    `‚è±Ô∏è *Estimated Time:* 15-20 minutes`,
    `üìç *Location:* Banda Street, Nairobi`,
    `üìû *Contact:* +254740940395`,
    ``,
    `üë®‚Äçüç≥ *Your order is being prepared. Thank you!*`
  ].filter(Boolean).join("\n");
}

function autoForwardToRestaurantWhatsApp(payload) {
  // Build restaurant message
  const restaurantMsg = buildRestaurantWhatsAppMessage(payload);
  const encodedRestaurantMsg = encodeURIComponent(restaurantMsg);
  
  // Build customer message
  const customerMsg = buildCustomerWhatsAppMessage(payload);
  const encodedCustomerMsg = encodeURIComponent(customerMsg);
  
  // Auto-open WhatsApp to restaurant number
  const restaurantUrl = `https://wa.me/${RESTAURANT_WHATSAPP.replace(/\D/g, "")}?text=${encodedRestaurantMsg}`;
  
  // Open in new tab
  const newWindow = window.open(restaurantUrl, '_blank');
  
  // If popup blocked, show instructions
  if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
    // Copy to clipboard as fallback
    navigator.clipboard.writeText(restaurantMsg).then(() => {
      showToast("Order details copied to clipboard. Please send to WhatsApp.");
    });
  }
  
  return customerMsg;
}

function finalizeOrderWithAutoWhatsApp(paymentLabel, paymentReference = "") {
  if (!requireTable()) return;

  if (cartItems.length === 0) {
    showToast("Your cart is empty", "warning");
    return;
  }

  const orderId = generateOrderId();
  const payload = {
    orderId,
    table: getTableLabel(),
    paymentLabel,
    paymentReference,
    items: cartItems.map(item => ({
      name: item.name,
      price: item.price,
      quantity: item.quantity
    })),
    total: cartTotal,
    count: cartCount,
    timestamp: new Date().toISOString()
  };

  lastOrderPayload = payload;

  // AUTO-FORWARD TO RESTAURANT WHATSAPP
  const customerMessage = autoForwardToRestaurantWhatsApp(payload);
  payload.customerMessage = customerMessage;

  // Success UI
  setTimeout(() => {
    el("paymentModal").classList.remove("open");
    el("successModal").classList.add("open");

    el("orderId").textContent = `ORDER-#${orderId}`;
    el("successTable").textContent = payload.table;
    el("successItems").textContent = String(payload.count);
    el("successTotal").textContent = fmtKES(payload.total);
    el("successPayment").textContent = payload.paymentLabel;
  }, 1000);
}

function finalizeOrder(paymentLabel) {
  finalizeOrderWithAutoWhatsApp(paymentLabel, "");
}

// Cart management functions for menu.js to use
window.cart = {
  addItem: function(item) {
    const existingItem = cartItems.find(cartItem => cartItem.id === item.id);
    if (existingItem) {
      existingItem.quantity += 1;
    } else {
      cartItems.push({
        ...item,
        quantity: 1
      });
    }
    updateCartTotal();
    updateCartUI();
    updateCheckoutButtonState();
    showToast(`${item.name} added to cart`);
  },
  
  removeItem: function(itemId) {
    cartItems = cartItems.filter(item => item.id !== itemId);
    updateCartTotal();
    updateCartUI();
    updateCheckoutButtonState();
  },
  
  clear: function() {
    cartItems = [];
    cartTotal = 0;
    cartCount = 0;
    updateCartUI();
    updateCheckoutButtonState();
  },
  
  getItems: function() {
    return cartItems;
  },
  
  getTotal: function() {
    return cartTotal;
  },
  
  getCount: function() {
    return cartCount;
  }
};

// Update button states continuously
function tick() {
  updateCheckoutButtonState();
  
  // Update Paystack button text with amount
  const paystackBtn = el("initiatePaystack");
  if (paystackBtn) {
    const amount = cartTotal;
    paystackBtn.textContent = amount > 0 
      ? `üì± Pay ${fmtKES(amount)} via M-Pesa`
      : `üì± Send Payment Request to Phone`;
  }
  
  requestAnimationFrame(tick);
}

// Initialize when DOM is loaded
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}
</script>
</body>
</html>
